@if (course) {
<div class="course-view-container">
    <header class="course-header">
        <h1>{{ course.title }}</h1>
        <p class="instructor">Taught by: {{ course.instructorName }}</p>
        <div class="rating-display">
            <span class="stars">
                @for (starNum of [1, 2, 3, 4, 5]; track starNum) {
                <span class="material-icons star-icon {{ (course.averageRating || 0) >= starNum ? 'filled' : '' }}">
                    {{ (course.averageRating || 0) >= starNum ? 'star' : 'star_border' }}
                </span>
                }
            </span>
            <span>{{ course.averageRating || 0 }} ({{ course.numberOfReviews || 0 }} reviews)</span>
        </div>

        @if (isEnrolled) {  
        <div class="rating-input-area">
            <h4>{{ userRating ? 'Your Rating:' : 'Rate this course:' }}</h4>

            <div classs="star-rating">
                @for (starNum of [1, 2, 3, 4, 5]; track starNum) {
                <span class="material-icons star-icon" (click)="rateCourse(starNum)"
                    (mouseenter)="hoverRating = starNum" (mouseleave)="hoverRating = 0"
                    [class.filled]="(hoverRating || userRating) >= starNum">
                    {{ (hoverRating || userRating) >= starNum ? 'star' : 'star_border' }}
                </span>
                }
            </div>
        </div>
        }
        <p class="description">{{ course.description }}</p>
        <div class="course-metadata">
            <span>Category: {{ course.category }}</span> |
            <span>Level: {{ course.difficultyLevel }}</span> |
            <span>Duration: {{ course.totalDurationInHours }} hours</span>
        </div>
        @if (course.coverImageUrl) {
        <img [src]="course.coverImageUrl" alt="Course Cover Image" class="cover-image">
        }
    </header>

    <section class="course-announcements">
        <div class="section-title-container">
            <h2>Course Announcements</h2>
            @if( isCourseInstructor && !announcementEdition && !isCreationMode ){
            <button (click)="startCreation()" class="btn-primary">Publish New Announcement</button>
            }
        </div>

        @if (isCreationMode || announcementEdition) {
        <div class="announcement-form-card">
            <h3 class="form-title">
                @if (announcementEdition) {
                Edit Announcement
                } @else {
                Create New Announcement
                }
            </h3>
            <form [formGroup]="announcementForm" (ngSubmit)="onFormSubmit()">
                <div class="form-group">
                    <label for="title">Title</label>
                    <input id="title" type="text" formControlName="title" required>
                    @if (announcementForm.get('title')?.invalid && (announcementForm.get('title')?.dirty ||
                    announcementForm.get('title')?.touched)) {
                    <div class="error-message">Title is required.</div>
                    }
                </div>

                <div class="form-group">
                    <label for="content">Content</label>
                    <textarea id="content" formControlName="content" rows="5" required></textarea>
                    @if (announcementForm.get('content')?.invalid && (announcementForm.get('content')?.dirty ||
                    announcementForm.get('content')?.touched)) {
                    <div class="error-message">Content is required.</div>
                    }
                </div>

                <div class="form-actions">
                    <button type="submit" [disabled]="announcementForm.invalid" class="btn-success">
                        <span class="material-icons">save</span>
                        Save
                    </button>
                    <button type="button" (click)="onCancel()" class="btn-secondary">
                        <span class="material-icons">cancel</span>
                        Cancel
                    </button>
                </div>
            </form>
        </div>
        }

        <div class="announcements-list">
            @for (announcement of course.announcements; track announcement.id) {
            <div class="announcement-item" [class.expanded]="announcement.isExpanded">

                <header class="announcement-header" (click)="toggleAccordeon(announcement)">
                    <h4 class="announcement-title">{{ announcement.title }}</h4>
                    <span class="date">{{ announcement.publishedDate | date }}</span>
                    <span class="material-icons toggle-icon">
                        {{ announcement.isExpanded ? 'expand_less' : 'expand_more' }}
                    </span>
                </header>

                @if (announcement.isExpanded) {
                <div class="announcement-content">
                    <p>{{ announcement.content }}</p>

                    @if (isCourseInstructor && !isCreationMode && !announcementEdition) {
                    <div class="actions-footer">
                        <button (click)="onEdit(announcement); $event.stopPropagation()" class="btn-edit">
                            <span class="material-icons">edit</span> Edit
                        </button>
                        <button (click)="onDelete(announcement.id); $event.stopPropagation()" class="btn-delete">
                            <span class="material-icons">delete</span> Delete
                        </button>
                    </div>
                    }
                </div>
                }
            </div>
            } @empty {
            <p class="empty-message">No announcements have been posted for this course yet.</p>
            }
        </div>
    </section>

    <hr>
    <div id="sectionsContainer" class="course-content">
        <h2>Course Content</h2>

        @for (section of course.sections; track section.id; let sectionIndex = $index) {
        <section class="course-section">
            <header class="section-header">
                <h3>Section {{ sectionIndex + 1 }}: {{ section.title }}</h3>
            </header>

            <ul class="content-list">
                @for (content of section.content; track content.id) {

                <li class="content-item">

                    <div class="lesson-header">
                        <span class="material-icons content-icon">
                            @switch (content.contentType) {
                            @case ('Video') { movie }
                            @case ('Pdf') { picture_as_pdf }
                            @case ('Word') { description }
                            @case ('Text') { notes }
                            @default { help_outline }
                            }
                        </span>

                        <div class="content-info">
                            <h4 class="content-title">{{ content.title }}</h4>
                            @if(content.description) {
                            <p class="content-description">{{ content.description }}</p>
                            }
                        </div>
                    </div>

                    <div class="content-body">
                        @switch (content.contentType) {
                        @case ('Video') {
                        @if(content.fileUrl){
                        <video [src]="backendBaseUrl + content.fileUrl" controls>
                            Your browser does not support the video tag.
                        </video>
                        }
                        }
                        @case ('Pdf') {
                        @if(content.fileUrl){
                        <a [href]="backendBaseUrl + content.fileUrl" target="_blank" class="content-link">
                            View PDF
                        </a>
                        }
                        }
                        @case ('Word') {
                        @if(content.fileUrl){
                        <a [href]="backendBaseUrl + content.fileUrl" download class="content-link">
                            Download Word Document
                        </a>
                        }
                        }
                        @case ('Text') {
                        <div class="text-content-display">
                            <p>{{ content.description || 'No text content available.' }}</p>
                        </div>
                        }
                        }
                    </div>

                </li>
                } @empty {
                <p class="empty-list-message">No content in this section yet.</p>
                }
            </ul>
        </section>
        } @empty {
        <p class="empty-list-message">This course has no sections yet.</p>
        }
    </div>
</div> } @else {
    <p>Loading course...</p>
}